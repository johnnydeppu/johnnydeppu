<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FootyJoy MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      const LS_KEY = "footyjoy.v1";
      const DEFAULT_FUN = ["Wonder goal","Elite pressing","Smart buildup","Tactical tweak","Young prospect","Derby vibes","Ref drama"];
      const DEFAULT_TAGS = ["Premier League","La Liga","Serie A","Bundesliga","Ligue 1","UCL","UEL","ECL"];

      function loadState(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return {matches:[],tags:DEFAULT_TAGS}; const p=JSON.parse(raw); return {matches:Array.isArray(p.matches)?p.matches:[], tags:Array.isArray(p.tags)&&p.tags.length?p.tags:DEFAULT_TAGS}; }catch(e){ return {matches:[],tags:DEFAULT_TAGS}; } }
      function saveState(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
      const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
      const todayISO = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
      const cn = (...c)=>c.filter(Boolean).join(" ");

      function App(){
        const [{matches,tags}, setState] = useState(loadState);
        const [query,setQuery]=useState(""), [filterTag,setFilterTag]=useState(""), [minRating,setMinRating]=useState(0);
        const [selectedId,setSelectedId]=useState(null); const searchRef=useRef(null);
        useEffect(()=>saveState({matches,tags}),[matches,tags]);
        useEffect(()=>{ function onKey(e){ if(e.key==="/"){ e.preventDefault(); searchRef.current?.focus(); } if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="n"){ e.preventDefault(); handleNewMatch(); } } window.addEventListener("keydown",onKey); return ()=>window.removeEventListener("keydown",onKey); },[matches,tags]);

        const selected = useMemo(()=> matches.find(m=>m.id===selectedId)||null, [matches,selectedId]);
        const filtered = useMemo(()=> {
          const q=query.trim().toLowerCase();
          return matches
            .filter(m=> filterTag ? (m.tags?.includes(filterTag)||m.funFactors?.includes(filterTag)) : true)
            .filter(m=> minRating ? Number(m.rating||0) >= minRating : true)
            .filter(m=> !q || [m.homeTeam,m.awayTeam,m.thoughts,m.competition,m.result,...(m.tags||[])].join(" ").toLowerCase().includes(q))
            .sort((a,b)=>(b.date||"").localeCompare(a.date||""));
        }, [matches,query,filterTag,minRating]);

        function updateMatch(partial){
          setState(s=> ({...s, matches:s.matches.map(m=> m.id===selectedId ? {...m, ...partial, updatedAt:Date.now()} : m)}));
        }
        function handleNewMatch(){
          const m={ id:uid(), date:todayISO(), competition:"", homeTeam:"", awayTeam:"", result:"", channel:"", rating:0, tags:[], thoughts:"", funFactors:[], moments:[], createdAt:Date.now(), updatedAt:Date.now() };
          setState(s=> ({...s, matches:[m, ...s.matches]})); setSelectedId(m.id);
        }
        function handleDeleteMatch(id){ setState(s=> ({...s, matches:s.matches.filter(m=>m.id!==id)})); if(selectedId===id) setSelectedId(null); }
        function addTag(label){ const t=label.trim(); if(!t) return; setState(s=> s.tags.includes(t)? s : {...s, tags:[...s.tags,t]}); }
        const toggleArrayItem=(arr,v)=> arr.includes(v)? arr.filter(x=>x!==v) : [...arr,v];

        function exportJSON(){ const data=JSON.stringify({matches,tags},null,2); const blob=new Blob([data],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`footyjoy-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
        function importJSON(file){ if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const p=JSON.parse(String(r.result||"{}")); setState({ matches:Array.isArray(p.matches)?p.matches:[], tags:Array.isArray(p.tags)&&p.tags.length?p.tags:DEFAULT_TAGS }); }catch(e){ alert("Import failed: "+e.message); } }; r.readAsText(file); }

        const tagCounts = useMemo(()=>{ const map=new Map(); for(const m of matches){ for(const t of (m.tags||[])) map.set(t,(map.get(t)||0)+1); for(const f of (m.funFactors||[])) map.set(f,(map.get(f)||0)+1); } return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,24); },[matches]);

        return (
          <div className="min-h-screen bg-slate-50 text-slate-900">
            <header className="sticky top-0 z-20 border-b bg-white/90 backdrop-blur">
              <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
                <div className="text-xl font-bold">⚽ FootyJoy <span className="text-slate-500 text-sm">(MVP)</span></div>
                <button onClick={handleNewMatch} className="ml-2 rounded-2xl bg-slate-900 text-white px-3 py-1.5 text-sm shadow hover:bg-black" title="New match (Ctrl/Cmd+N)">+ New match</button>
                <div className="ml-4 flex items-center gap-2">
                  <input ref={searchRef} value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search ( / )" className="w-64 rounded-xl border px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400"/>
                  <select value={filterTag} onChange={e=>setFilterTag(e.target.value)} className="rounded-xl border px-3 py-1.5 text-sm">
                    <option value="">All tags</option>
                    {[...new Set([...tags, ...DEFAULT_FUN])].map(t=> <option key={t} value={t}>{t}</option>)}
                  </select>
                  <div className="flex items-center gap-2 text-sm">
                    <span className="text-slate-500">Min rating</span>
                    <input type="range" min={0} max={10} value={minRating} onChange={e=>setMinRating(Number(e.target.value))}/>
                    <span className="w-6 text-center font-medium">{minRating}</span>
                  </div>
                </div>
                <div className="ml-auto flex items-center gap-2">
                  <button onClick={exportJSON} className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-100">Export</button>
                  <label className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-100 cursor-pointer">
                    Import
                    <input type="file" accept="application/json" className="hidden" onChange={e=>importJSON(e.target.files?.[0])}/>
                  </label>
                </div>
              </div>
            </header>

            <main className="mx-auto max-w-7xl px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
              <section className="lg:col-span-1">
                <div className="rounded-3xl bg-white p-4 shadow-sm">
                  <div className="flex items-center justify-between">
                    <h2 className="text-lg font-semibold">{selected ? "Edit match" : "Create a match"}</h2>
                    {selected && <button onClick={()=>handleDeleteMatch(selected.id)} className="text-sm text-red-600 hover:underline">Delete</button>}
                  </div>
                  <div className="mt-3 grid grid-cols-2 gap-3">
                    <div className="col-span-1"><label className="text-xs text-slate-500">Date</label><input type="date" value={selected?.date || todayISO()} onChange={e=>selected?updateMatch({date:e.target.value}):null} className="w-full rounded-xl border px-3 py-1.5"/></div>
                    <div className="col-span-1"><label className="text-xs text-slate-500">Competition</label><input value={selected?.competition || ""} onChange={e=>updateMatch({competition:e.target.value})} placeholder="UCL, Premier League..." className="w-full rounded-xl border px-3 py-1.5"/></div>
                    <div className="col-span-1"><label className="text-xs text-slate-500">Home team</label><input value={selected?.homeTeam || ""} onChange={e=>updateMatch({homeTeam:e.target.value})} className="w-full rounded-xl border px-3 py-1.5"/></div>
                    <div className="col-span-1"><label className="text-xs text-slate-500">Away team</label><input value={selected?.awayTeam || ""} onChange={e=>updateMatch({awayTeam:e.target.value})} className="w-full rounded-xl border px-3 py-1.5"/></div>
                    <div className="col-span-1"><label className="text-xs text-slate-500">Result</label><input value={selected?.result || ""} onChange={e=>updateMatch({result:e.target.value})} placeholder="2-1" className="w-full rounded-xl border px-3 py-1.5"/></div>
                    <div className="col-span-1"><label className="text-xs text-slate-500">Channel / Stream</label><input value={selected?.channel || ""} onChange={e=>updateMatch({channel:e.target.value})} placeholder="DAZN, WOWOW..." className="w-full rounded-xl border px-3 py-1.5"/></div>
                    <div className="col-span-2"><label className="text-xs text-slate-500">Rating: <span className="font-medium">{selected?.rating || 0}</span></label><input type="range" min={0} max={10} step={1} value={selected?.rating || 0} onChange={e=>updateMatch({rating:Number(e.target.value)})} className="w-full"/></div>
                    <div className="col-span-2"><label className="text-xs text-slate-500">Tags (comma to add)</label><TagEditor value={selected?.tags||[]} onAdd={t=>updateMatch({tags:[...new Set([...(selected?.tags||[]), t])]})} onRemove={t=>updateMatch({tags:(selected?.tags||[]).filter(x=>x!==t)})} suggestions={[...new Set([...tags, ...DEFAULT_FUN])]} /></div>
                    <div className="col-span-2"><label className="text-xs text-slate-500">Thoughts</label><textarea value={selected?.thoughts || ""} onChange={e=>updateMatch({thoughts:e.target.value})} rows={5} className="w-full rounded-xl border px-3 py-2" placeholder="What made this match special?"/></div>
                  </div>

                  <div className="mt-3"><div className="text-xs text-slate-500 mb-1">Quick toggles</div>
                    <div className="flex flex-wrap gap-2">
                      {DEFAULT_FUN.map(f=>(
                        <button key={f} onClick={()=>updateMatch({funFactors: (selected?.funFactors||[]).includes(f) ? (selected?.funFactors||[]).filter(x=>x!==f) : [...(selected?.funFactors||[]), f]})} className={cn("px-2.5 py-1 rounded-full text-xs border", (selected?.funFactors||[]).includes(f)?"bg-slate-900 text-white border-slate-900":"hover:bg-slate-100")}>{f}</button>
                      ))}
                    </div>
                  </div>

                  <MomentsEditor selected={selected} updateMatch={updateMatch} tags={tags} />

                  <div className="mt-6 border-t pt-4">
                    <div className="text-sm font-semibold mb-2">Your tag bank</div>
                    <TagBank tags={tags} onAdd={label => { const t=String(label||"").trim(); if(!t) return; setState(s=> s.tags.includes(t)? s : {...s, tags:[...s.tags,t]}); }} />
                  </div>
                </div>
              </section>

              <section className="lg:col-span-2">
                <div className="rounded-3xl bg-white p-4 shadow-sm">
                  <div className="flex items-center justify-between">
                    <h2 className="text-lg font-semibold">Matches <span className="text-slate-400 text-sm">({filtered.length})</span></h2>
                    <div className="text-xs text-slate-500">Tip: <kbd className="px-1.5 py-0.5 border rounded">/</kbd> search, <kbd className="px-1.5 py-0.5 border rounded">Ctrl/Cmd+N</kbd> add</div>
                  </div>

                  <div className="mt-3 flex flex-wrap gap-2">
                    {tagCounts.map(([t,c])=>(
                      <button key={t} onClick={()=>setFilterTag(String(t))} className={cn("px-2.5 py-1 rounded-full text-xs border", filterTag===t?"bg-slate-900 text-white border-slate-900":"hover:bg-slate-100")}>{t}<span className="ml-1 text-slate-500">{c}</span></button>
                    ))}
                  </div>

                  <div className="mt-4 divide-y">
                    {filtered.map(m=>(
                      <article key={m.id} className={cn("py-3 flex gap-4", selectedId===m.id && "bg-slate-50 rounded-2xl px-3")}>
                        <div className="w-16 text-center"><div className="text-xs text-slate-500">{m.date}</div><div className="mt-1 text-lg font-semibold">{m.rating ?? 0}</div></div>
                        <div className="flex-1 min-w-0 cursor-pointer" onClick={()=>setSelectedId(m.id)}>
                          <div className="flex flex-wrap items-center gap-2">
                            <span className="font-semibold">{m.homeTeam || "(home)"}</span><span className="text-slate-400">vs</span><span className="font-semibold">{m.awayTeam || "(away)"}</span>
                            {m.result && <span className="ml-2 rounded border px-1.5 text-xs">{m.result}</span>}
                            {m.competition && <span className="ml-1 rounded-full border px-2 text-xs">{m.competition}</span>}
                          </div>
                          {m.thoughts && <p className="mt-1 line-clamp-2 text-sm text-slate-600">{m.thoughts}</p>}
                          <div className="mt-2 flex flex-wrap gap-1.5">
                            {(m.tags||[]).map(t=> <span key={t} className="rounded-full bg-slate-100 px-2 py-0.5 text-xs">{t}</span>)}
                            {(m.funFactors||[]).map(t=> <span key={t} className="rounded-full bg-black text-white px-2 py-0.5 text-xs">{t}</span>)}
                          </div>
                        </div>
                        <div className="shrink-0 self-center"><button onClick={()=>handleDeleteMatch(m.id)} className="text-xs text-red-600 hover:underline">Delete</button></div>
                      </article>
                    ))}

                    {!filtered.length && <div className="p-8 text-center text-slate-500 text-sm">No matches yet. Click <b>New match</b> to start, then jot your notes as you watch. Add moments like “67’: back-post run”.</div>}
                  </div>
                </div>
              </section>
            </main>

            <footer className="py-8 text-center text-xs text-slate-400">Built fast with ❤️ — v0.1. Keyboard: <kbd className="px-1 py-0.5 border rounded">/</kbd> search, <kbd className="px-1 py-0.5 border rounded">Ctrl/Cmd+N</kbd> new</footer>
          </div>
        );
      }

      function TagEditor({ value, onAdd, onRemove, suggestions }){
        const [draft,setDraft]=useState("");
        function add(){ const parts=draft.split(",").map(s=>s.trim()).filter(Boolean); for(const p of parts) onAdd(p); setDraft(""); }
        return (<div>
          <div className="flex flex-wrap gap-2 mb-2">{value.map(t=>(
            <span key={t} className="inline-flex items-center gap-1 rounded-full bg-slate-100 px-2 py-0.5 text-xs">{t}
              <button onClick={()=>onRemove(t)} className="ml-1 text-slate-500 hover:text-black">×</button>
            </span>
          ))}</div>
          <div className="flex gap-2"><input value={draft} onChange={e=>setDraft(e.target.value)} placeholder="Type tag, press Enter" className="flex-1 rounded-xl border px-3 py-1.5" onKeyDown={e=>{ if(e.key==='Enter'){ e.preventDefault(); add(); }}}/><button onClick={add} className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-100">Add</button></div>
          {!!suggestions?.length && <div className="mt-2 flex flex-wrap gap-1.5">{suggestions.slice(0,20).map(s=> <button key={s} onClick={()=>onAdd(s)} className="rounded-full border px-2 py-0.5 text-xs hover:bg-slate-50">{s}</button>)}</div>}
        </div>);
      }

      function TagBank({ tags, onAdd }){
        const [draft,setDraft]=useState("");
        return (<div>
          <div className="flex flex-wrap gap-1.5">{tags.map(t=> <button key={t} onClick={()=>onAdd(t)} className="rounded-full border px-2 py-0.5 text-xs hover:bg-slate-50">{t}</button>)}</div>
          <div className="mt-2 flex gap-2"><input value={draft} onChange={e=>setDraft(e.target.value)} placeholder="Add new tag to bank" className="flex-1 rounded-xl border px-3 py-1.5" onKeyDown={e=>{ if(e.key==='Enter'){ e.preventDefault(); onAdd(draft); setDraft(""); }}}/><button onClick={()=>{ onAdd(draft); setDraft(""); }} className="rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-100">Add</button></div>
        </div>);
      }

      function MomentsEditor({ selected, updateMatch, tags }){
        const [minStr,setMinStr]=useState(""), [note,setNote]=useState(""), [picked,setPicked]=useState([]);
        if(!selected) return null;
        function add(){ const minute=Number(minStr); const tagIds=picked; updateMatch({ moments:[...(selected.moments||[]), { id:uid(), minute:isNaN(minute)?null:minute, note, tagIds }] }); setMinStr(""); setNote(""); setPicked([]); }
        function remove(mid){ updateMatch({ moments:(selected.moments||[]).filter(m=>m.id!==mid) }); }
        return (<div className="mt-6 border-t pt-4">
          <div className="flex items-center justify-between"><div className="text-sm font-semibold">Moments</div><div className="text-xs text-slate-500">Log key plays with minute + quick note</div></div>
          <div className="mt-2 grid grid-cols-6 gap-2">
            <input className="col-span-1 rounded-xl border px-3 py-1.5" placeholder="67" value={minStr} onChange={e=>setMinStr(e.target.value)} />
            <input className="col-span-3 rounded-xl border px-3 py-1.5" placeholder="Back-post run + cutback" value={note} onChange={e=>setNote(e.target.value)} />
            <select multiple value={picked} onChange={e=> setPicked([...e.target.selectedOptions].map(o=>o.value))} className="col-span-1 rounded-xl border px-2 py-1.5 min-h-[38px]">
              {[...new Set(tags)].map(t=> <option key={t} value={t}>{t}</option>)}
            </select>
            <button onClick={add} className="col-span-1 rounded-xl border px-3 py-1.5 text-sm hover:bg-slate-100">Add</button>
          </div>
          <div className="mt-3 space-y-2">
            {(selected.moments||[]).map(m=>(
              <div key={m.id} className="rounded-2xl border p-2 flex items-center gap-3 justify-between">
                <div className="flex items-center gap-3">
                  <span className="inline-flex h-7 w-7 items-center justify-center rounded-full bg-slate-900 text-white text-sm">{m.minute ?? "—"}</span>
                  <div>
                    <div className="text-sm">{m.note}</div>
                    <div className="flex flex-wrap gap-1.5 mt-1">{(m.tagIds||[]).map(t=> <span key={t} className="rounded-full bg-slate-100 px-2 py-0.5 text-xs">{t}</span>)}</div>
                  </div>
                </div>
                <button onClick={()=>remove(mid)} className="text-xs text-slate-500 hover:text-red-600">Delete</button>
              </div>
            ))}
          </div>
        </div>);
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  </body>
</html>
